<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>kid_readout.analysis.noise_measurement &mdash; KID Readout  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="KID Readout  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">KID Readout  documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for kid_readout.analysis.noise_measurement</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;agg&#39;</span><span class="p">)</span>
<span class="c">#matplotlib.rcParams[&#39;mathtext.fontset&#39;] = &#39;stix&#39;</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span>
<span class="n">mlab</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">mlab</span>

<span class="kn">from</span> <span class="nn">kid_readout.analysis.resonator</span> <span class="kn">import</span> <span class="n">Resonator</span><span class="p">,</span><span class="n">fit_best_resonator</span>
<span class="kn">from</span> <span class="nn">kid_readout.analysis</span> <span class="kn">import</span> <span class="n">iqnoise</span>
<span class="kn">from</span> <span class="nn">kid_readout.utils</span> <span class="kn">import</span> <span class="n">readoutnc</span>

<span class="c">#from kid_readout.utils.fftfilt import fftfilt</span>
<span class="kn">from</span> <span class="nn">kid_readout.utils.filters</span> <span class="kn">import</span> <span class="n">low_pass_fir</span>

<span class="kn">from</span> <span class="nn">kid_readout.utils.despike</span> <span class="kn">import</span> <span class="n">deglitch_window</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;detectors&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">kid_readout.utils.hpd_temps</span> <span class="kn">import</span> <span class="n">get_temperatures_at</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">kid_readout.utils.starcryo_temps</span> <span class="kn">import</span> <span class="n">get_temperatures_at</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">kid_readout.analysis.resources</span> <span class="kn">import</span> <span class="n">experiments</span>

<span class="kn">import</span> <span class="nn">cPickle</span>


<div class="viewcode-block" id="plot_noise_nc"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.plot_noise_nc">[docs]</a><span class="k">def</span> <span class="nf">plot_noise_nc</span><span class="p">(</span><span class="n">fglob</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create noise measurements from all noise sweeps in a netcdf file, make plots, and pickle the noise measurements</span>
<span class="sd">    </span>
<span class="sd">    fglob : string or list</span>
<span class="sd">        filename glob. Can be either a filename, which can contain * or ? wildcards, or a list of files</span>
<span class="sd">    </span>
<span class="sd">    plot_all : bool (default False)</span>
<span class="sd">        if True, plot all sweeps, otherwise just plot the first one for each resonator</span>
<span class="sd">        </span>
<span class="sd">    **kwargs are passed to the noise measurement class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fglob</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fglob</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">fglob</span>
    <span class="n">plotall</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;plot_all&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">fnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fdir</span><span class="p">,</span><span class="n">fbase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">fbase</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fbase</span><span class="p">)</span>
            <span class="n">rnc</span> <span class="o">=</span> <span class="n">readoutnc</span><span class="o">.</span><span class="n">ReadoutNetCDF</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">nms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,((</span><span class="n">sname</span><span class="p">,</span><span class="n">swg</span><span class="p">),(</span><span class="n">tname</span><span class="p">,</span><span class="n">tsg</span><span class="p">)))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rnc</span><span class="o">.</span><span class="n">sweeps_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">rnc</span><span class="o">.</span><span class="n">timestreams_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())):</span>
                <span class="c">#fig = plot_noise(swg,tsg,hwg,chip,**kwargs)</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">swg</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">nm</span> <span class="o">=</span> <span class="n">SweepNoiseMeasurement</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">sweep_group_index</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">timestream_group_index</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                                                   <span class="n">resonator_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;failed to find index&quot;</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">sname</span><span class="p">,</span><span class="n">tname</span>
                        <span class="k">continue</span>
                    

                    <span class="k">if</span> <span class="n">plotall</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">chipfname</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">chip_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                                <span class="n">pdfname</span> <span class="o">=</span> <span class="s">&#39;/home/data/plots/</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fbase</span><span class="p">,</span><span class="n">chipfname</span><span class="p">)</span>
                                <span class="n">pdf</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">pdfname</span><span class="p">,</span><span class="mo">0666</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                    <span class="k">print</span> <span class="s">&quot;could not change permissions of&quot;</span><span class="p">,</span><span class="n">pdfname</span>
    
                            <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sname</span><span class="p">,</span><span class="n">tname</span><span class="p">))</span>
                            <span class="n">nm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
                            <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                            <span class="n">fig</span><span class="o">.</span><span class="n">set_canvas</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
                            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;failed to plot&quot;</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">sname</span><span class="p">,</span><span class="n">tname</span><span class="p">,</span><span class="n">fname</span>
<span class="c">#                    else:</span>
<span class="c">#                        if pdf is not None:</span>
<span class="c">#                            pdf.close()</span>
<span class="c">#                            pdf = None</span>
                    <span class="n">nm</span><span class="o">.</span><span class="n">_fractional_fluctuation_timeseries</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">nms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
                    
                <span class="k">print</span> <span class="n">fname</span><span class="p">,</span><span class="n">nm</span><span class="o">.</span><span class="n">start_temp</span><span class="p">,</span><span class="s">&quot;K&quot;</span>
            <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pdf</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">rnc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pklname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;/home/data&#39;</span><span class="p">,</span><span class="s">&#39;noise_sweeps_&#39;</span> <span class="o">+</span><span class="n">fbase</span><span class="o">+</span><span class="s">&#39;.pkl&#39;</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">nms</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span><span class="mo">0666</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;could not change permissions of&quot;</span><span class="p">,</span> <span class="n">pklname</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
<span class="c">#            raise</span>
            <span class="n">errors</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">errors</span>
</div>
<div class="viewcode-block" id="SweepNoiseMeasurement"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement">[docs]</a><span class="k">class</span> <span class="nc">SweepNoiseMeasurement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sweep_filename</span><span class="p">,</span><span class="n">sweep_group_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">timestream_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">timestream_group_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">resonator_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">low_pass_cutoff_Hz</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                 <span class="n">dac_chain_gain</span> <span class="o">=</span> <span class="o">-</span><span class="mi">49</span><span class="p">,</span> <span class="n">delay_estimate</span><span class="o">=-</span><span class="mf">7.29</span><span class="p">,</span>
                 <span class="n">deglitch_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cryostat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mask_sweep_indicies</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sweep_filename : str</span>
<span class="sd">            NetCDF4 file with at least the sweep data. By default, this is also used for the timestream data.</span>
<span class="sd">            </span>
<span class="sd">        sweep_group_index : int (default 0)</span>
<span class="sd">            Index of the sweep group to process</span>
<span class="sd">            </span>
<span class="sd">        timestream_filename : str or None (optional)</span>
<span class="sd">            If None, use sweep_filename for the timestream data</span>
<span class="sd">            otherwise, this is the NetCDF4 file with the timestream data</span>
<span class="sd">            </span>
<span class="sd">        timestream_group_index : int (default 0)</span>
<span class="sd">            Index of the timestream group to process</span>
<span class="sd">        </span>
<span class="sd">        resonator_index : int (default 0)</span>
<span class="sd">            index of the resonator to process data for</span>
<span class="sd">            </span>
<span class="sd">        low_pass_cutoff_Hz : float</span>
<span class="sd">            Cutoff frequency used for low pass filtering the timeseries for display</span>
<span class="sd">            </span>
<span class="sd">        dac_chain_gain : float</span>
<span class="sd">            Estimate of the gain from output of DAC to device. </span>
<span class="sd">            Default value of -49 represents -2 dB loss intrinsic to analog signal conditioning</span>
<span class="sd">            board, 7 dB misc cable loss and 40 dB total cold</span>
<span class="sd">            attenuation.</span>
<span class="sd">        </span>
<span class="sd">        delay_estimate : float</span>
<span class="sd">            Estimate of basic cable delay to help fitting proceed more smoothly. Default value</span>
<span class="sd">            is appropriate for the wideband noise firmware</span>
<span class="sd">            </span>
<span class="sd">        deglitch_threshold : float</span>
<span class="sd">            Threshold for glitch detection in units of median absolute deviation.</span>
<span class="sd">            </span>
<span class="sd">        cryostat : str</span>
<span class="sd">            (Optional) Override the cryostat used to take this data. By default, the cryostat</span>
<span class="sd">            is guessed based on the machine you are processing data on. The guess is made by</span>
<span class="sd">            the get_experiment_info_at function</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_filename</span> <span class="o">=</span> <span class="n">sweep_filename</span>
        <span class="k">if</span> <span class="n">timestream_filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestream_filename</span> <span class="o">=</span> <span class="n">timestream_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestream_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_group_index</span> <span class="o">=</span> <span class="n">sweep_group_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_group_index</span> <span class="o">=</span> <span class="n">timestream_group_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">start_epoch</span>
        <span class="n">pkg1</span><span class="p">,</span><span class="n">pkg2</span><span class="p">,</span><span class="n">load1</span><span class="p">,</span><span class="n">load2</span> <span class="o">=</span> <span class="n">get_temperatures_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_primary_package_temperature</span> <span class="o">=</span> <span class="n">pkg1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_secondary_package_temperature</span> <span class="o">=</span> <span class="n">pkg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_primary_load_temperature</span> <span class="o">=</span> <span class="n">load1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_secondary_load_temperature</span> <span class="o">=</span> <span class="n">load2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_primary_package_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resonator_index</span> <span class="o">=</span> <span class="n">resonator_index</span>
        
        <span class="n">info</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">get_experiment_info_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_epoch</span><span class="p">,</span> <span class="n">cryostat</span><span class="o">=</span><span class="n">cryostat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_description</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chip_name</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;chip_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dark</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;is_dark&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optical_state</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;optical_state&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dac_chain_gain</span> <span class="o">=</span> <span class="n">dac_chain_gain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmw_atten_turns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span><span class="o">.</span><span class="n">mmw_atten_turns</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_dac_atten</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span><span class="o">.</span><span class="n">get_effective_dac_atten_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_dbm</span> <span class="o">=</span> <span class="n">dac_chain_gain</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_dac_atten</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;failed to find attenuator settings&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_dac_atten</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_dbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">select_by_index</span><span class="p">(</span><span class="n">resonator_index</span><span class="p">)</span>
        
        <span class="c"># find the time series that was measured closest to the sweep frequencies</span>
        <span class="c"># this is a bit sloppy...</span>
        <span class="n">timestream_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">measurement_freq</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_index</span> <span class="o">=</span> <span class="n">timestream_index</span>
        
        <span class="n">original_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">get_data_index</span><span class="p">(</span><span class="n">timestream_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adc_sampling_freq_MHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">adc_sampling_freq</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">measurement_freq</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">nfft</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_modulation_duty_cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">modulation_duty_cycle</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_modulation_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">modulation_freq</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_modulation_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">modulation_phase</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_modulation_period_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">modulation_period_samples</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">epoch</span><span class="p">[</span><span class="n">timestream_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_duration</span> <span class="o">=</span> <span class="n">original_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span>
        <span class="c"># The following hack helps fix a long standing timing bug which was recently fixed/improved</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream_epoch</span> <span class="o">&lt;</span> <span class="mi">1399089567</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestream_epoch</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream_duration</span>
        <span class="c"># end hack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_temperatures_sample_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_duration</span><span class="p">)</span>
        <span class="n">pkg1</span><span class="p">,</span><span class="n">pkg2</span><span class="p">,</span><span class="n">load1</span><span class="p">,</span><span class="n">load2</span> <span class="o">=</span> <span class="n">get_temperatures_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_epoch</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream_temperatures_sample_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_primary_package_temperature</span> <span class="o">=</span> <span class="n">pkg1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_secondary_package_temperature</span> <span class="o">=</span> <span class="n">pkg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_primary_load_temperature</span> <span class="o">=</span> <span class="n">load1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestream_secondary_load_temperature</span> <span class="o">=</span> <span class="n">load2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream_primary_package_temperature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        
        <span class="c"># We can use the timestream measurement as an additional sweep point.</span>
        <span class="c"># We average only the first 2048 points of the timeseries to avoid any drift.</span>
        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">,[</span><span class="n">original_timeseries</span><span class="p">[:</span><span class="mi">2048</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span><span class="p">,</span>
                                               <span class="p">[</span><span class="n">original_timeseries</span><span class="p">[:</span><span class="mi">2048</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
                                                <span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">original_timeseries</span><span class="p">[:</span><span class="mi">2048</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2048</span><span class="p">)]))</span>
        
        <span class="c"># Now put all the sweep data in increasing frequency order so it plots nicely</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mask_sweep_indicies</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">fit_best_resonator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span><span class="p">,</span><span class="n">delay_estimate</span><span class="o">=</span><span class="n">delay_estimate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">mask_sweep_indicies</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">fit_best_resonator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">delay_estimate</span><span class="o">=</span><span class="n">delay_estimate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resonator_model</span> <span class="o">=</span> <span class="n">rr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q_i</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">Q_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_params</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span>
        
        <span class="n">decimation_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="o">/</span><span class="n">low_pass_cutoff_Hz</span>
        <span class="n">normalized_timeseries</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">,</span><span class="n">original_timeseries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_pass_normalized_timeseries</span> <span class="o">=</span> <span class="n">low_pass_fir</span><span class="p">(</span><span class="n">normalized_timeseries</span><span class="p">,</span> <span class="n">num_taps</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">low_pass_cutoff_Hz</span><span class="p">,</span> 
                                                          <span class="n">nyquist_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">,</span> <span class="n">decimate_by</span><span class="o">=</span><span class="n">decimation_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_timeseries_mean</span> <span class="o">=</span> <span class="n">normalized_timeseries</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">projected_timeseries</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">project_s21_to_delta_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">,</span><span class="n">normalized_timeseries</span><span class="p">,</span>
                                                            <span class="n">s21_already_normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c"># calculate the number of samples for the deglitching window.</span>
        <span class="c"># the following will be the next power of two above 1 second worth of samples</span>
        <span class="n">window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">)))</span>
        <span class="c"># reduce the deglitching window if we don&#39;t have enough samples</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="n">projected_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">projected_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deglitch_window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deglitch_threshold</span> <span class="o">=</span> <span class="n">deglitch_threshold</span>
        <span class="k">if</span> <span class="n">deglitch_threshold</span><span class="p">:</span>
            <span class="n">deglitched_timeseries</span> <span class="o">=</span> <span class="n">deglitch_window</span><span class="p">(</span><span class="n">projected_timeseries</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">deglitch_threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deglitched_timeseries</span> <span class="o">=</span> <span class="n">projected_timeseries</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">low_pass_projected_timeseries</span> <span class="o">=</span> <span class="n">low_pass_fir</span><span class="p">(</span><span class="n">deglitched_timeseries</span><span class="p">,</span> <span class="n">num_taps</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">low_pass_cutoff_Hz</span><span class="p">,</span> 
                                                <span class="n">nyquist_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">,</span> <span class="n">decimate_by</span><span class="o">=</span><span class="n">decimation_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_pass_timestep</span> <span class="o">=</span> <span class="n">decimation_factor</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_meas_freq</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">normalized_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_resonance</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">normalized_model</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">f_0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_ds21_df_at_meas_freq</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">approx_normalized_gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_freqs_MHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">normalized_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_freqs_MHz</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_timeseries_mean</span>
        
        <span class="n">fractional_fluctuation_timeseries</span> <span class="o">=</span> <span class="n">deglitched_timeseries</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fractional_fluctuation_timeseries</span> <span class="o">=</span> <span class="n">fractional_fluctuation_timeseries</span>
        <span class="n">fr</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">evals</span><span class="p">,</span><span class="n">evects</span><span class="p">,</span><span class="n">angles</span><span class="p">,</span><span class="n">piq</span> <span class="o">=</span> <span class="n">iqnoise</span><span class="o">.</span><span class="n">pca_noise</span><span class="p">(</span><span class="n">fractional_fluctuation_timeseries</span><span class="p">,</span> 
                                                         <span class="n">NFFT</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_freq</span> <span class="o">=</span> <span class="n">fr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_S</span> <span class="o">=</span> <span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_eigvals</span> <span class="o">=</span> <span class="n">evals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_eigvects</span> <span class="o">=</span> <span class="n">evects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_angles</span> <span class="o">=</span> <span class="n">angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_piq</span> <span class="o">=</span> <span class="n">piq</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">freqs_coarse</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prr_coarse</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pii_coarse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projected_fractional_fluctuation_spectra</span><span class="p">(</span><span class="n">NFFT</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">12</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalized_timeseries</span> <span class="o">=</span> <span class="n">normalized_timeseries</span><span class="p">[:</span><span class="mi">2048</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_files</span><span class="p">()</span>
        
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.original_timeseries"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.original_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">original_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the original demodulated timeseries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream</span><span class="o">.</span><span class="n">get_data_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_index</span><span class="p">)</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.normalized_timeseries"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.normalized_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">normalized_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the timeseries after normalizing it to remove the arbitrary amplitude, phase, and delay corrections</span>
<span class="sd">        determined by the resonator fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resonator_model</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">original_timeseries</span><span class="p">)</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.projected_timeseries"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.projected_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">projected_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the timeseries after projecting it into the dissipation and frequency directions (in units of Hz)</span>
<span class="sd">        determined by the resonator fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resonator_model</span><span class="o">.</span><span class="n">project_s21_to_delta_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_timeseries</span><span class="p">,</span>
                                                            <span class="n">s21_already_normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.fractional_fluctuation_timeseries"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.fractional_fluctuation_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">fractional_fluctuation_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the fractional fluctuation timeseries (projected divided by resonant frequency)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractional_fluctuation_timeseries</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fractional_fluctuation_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deglitched_timeseries</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractional_fluctuation_timeseries</span>
        </div>
<div class="viewcode-block" id="SweepNoiseMeasurement.get_deglitched_timeseries"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.get_deglitched_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">get_deglitched_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">window_in_seconds</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the deglitched, projected timeseries</span>
<span class="sd">        </span>
<span class="sd">        window_in_seconds : float</span>
<span class="sd">            deglitching window duration</span>
<span class="sd">            </span>
<span class="sd">        thresh : float</span>
<span class="sd">            threshold in median absoute deviations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># calculate the number of samples for the deglitching window.</span>
        <span class="c"># the following will be the next power of two above 1 second worth of samples</span>
        <span class="n">window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">window_in_seconds</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">)))</span>
        <span class="c"># reduce the deglitching window if we don&#39;t have enough samples</span>
        <span class="n">projected_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projected_timeseries</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="n">projected_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">projected_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
            
        <span class="k">if</span> <span class="n">thresh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deglitch_threshold</span>

        <span class="n">deglitched_timeseries</span> <span class="o">=</span> <span class="n">deglitch_window</span><span class="p">(</span><span class="n">projected_timeseries</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deglitched_timeseries</span>
    </div>
<div class="viewcode-block" id="SweepNoiseMeasurement.get_projected_fractional_fluctuation_spectra"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.get_projected_fractional_fluctuation_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_projected_fractional_fluctuation_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">NFFT</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">12</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="n">mlab</span><span class="o">.</span><span class="n">window_none</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the PSD of the fractional fluctuation timeseries using mlab.psd.</span>
<span class="sd">        </span>
<span class="sd">        NFFT : int</span>
<span class="sd">            length of the FFT to compute. Sets freuqency resolution.</span>
<span class="sd">            </span>
<span class="sd">        window : function</span>
<span class="sd">            windowing function. i.e. mlab.window_hamming etc.</span>
<span class="sd">        </span>
<span class="sd">        Returns: freqs,prr,pii</span>
<span class="sd">        </span>
<span class="sd">        freqs : float array</span>
<span class="sd">            Frequencies in Hz</span>
<span class="sd">        </span>
<span class="sd">        prr : float array</span>
<span class="sd">            dissipation spectrum. Units are 1/Hz</span>
<span class="sd">            </span>
<span class="sd">        pii : float array</span>
<span class="sd">            frequency fluctuation spectrum. Units are 1/Hz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prr</span><span class="p">,</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">psd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractional_fluctuation_timeseries</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">NFFT</span><span class="o">=</span><span class="n">NFFT</span><span class="p">,</span>
                                                           <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span><span class="n">Fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">)</span>
        <span class="n">pii</span><span class="p">,</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">psd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractional_fluctuation_timeseries</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">NFFT</span><span class="o">=</span><span class="n">NFFT</span><span class="p">,</span>
                                                           <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span><span class="n">Fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries_sample_rate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">freqs</span><span class="p">,</span><span class="n">prr</span><span class="p">,</span><span class="n">pii</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.sweep"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.sweep">[docs]</a>    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sweep group from the netcdf file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_sweep_file</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span><span class="o">.</span><span class="n">sweeps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_group_index</span><span class="p">]</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.timestream"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.timestream">[docs]</a>    <span class="k">def</span> <span class="nf">timestream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the timestream group from the netcdf file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_timestream_file</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span><span class="o">.</span><span class="n">timestreams</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_group_index</span><span class="p">]</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="SweepNoiseMeasurement.resonator_model"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.resonator_model">[docs]</a>    <span class="k">def</span> <span class="nf">resonator_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resonator_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_resonator_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resonator_model</span>
    </div>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For pickling, make sure we get rid of everything unpicklable and large</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_files</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c">#        del d[&#39;_sweep_file&#39;]</span>
<span class="c">#        del d[&#39;_timestream_file&#39;]</span>
<span class="c">#        del d[&#39;sweep&#39;]</span>
<span class="c">#        del d[&#39;timestream&#39;]</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;_resonator_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;_fractional_fluctuation_timeseries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">d</span>
        
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore from pickling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">state</span>
<span class="c">#        try:</span>
<span class="c">#            self._open_netcdf_files()</span>
<span class="c">#        except IOError:</span>
<span class="c">#            print &quot;Warning: could not open associated NetCDF datafiles when unpickling.&quot;</span>
<span class="c">#            print &quot;Some features of the class will not be available&quot;</span>
<span class="c">#        try:</span>
<span class="c">#            self._restore_resonator_model()</span>
<span class="c">#        except Exception, e:</span>
<span class="c">#            print &quot;error while restoring resonator model:&quot;,e</span>
            
    <span class="k">def</span> <span class="nf">_open_sweep_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span> <span class="o">=</span> <span class="n">readoutnc</span><span class="o">.</span><span class="n">ReadoutNetCDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_timestream_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span> <span class="o">=</span> <span class="n">readoutnc</span><span class="o">.</span><span class="n">ReadoutNetCDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_filename</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_close_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sweep_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestream_file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_restore_resonator_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resonator_model</span> <span class="o">=</span> <span class="n">fit_best_resonator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_s21</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_errors</span><span class="p">,</span>
                                                  <span class="n">delay_estimate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="s">&#39;delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="SweepNoiseMeasurement.plot"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.SweepNoiseMeasurement.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make standard plot of noise sweep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
        <span class="n">ax2b</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ax2b</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="s">&#39;.-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;measured frequency sweep&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="s">&#39;.-&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;model frequency sweep&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_resonance</span><span class="o">.</span><span class="n">real</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_resonance</span><span class="o">.</span><span class="n">imag</span><span class="p">],</span><span class="s">&#39;kx&#39;</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;model f0&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_timeseries_mean</span><span class="o">.</span><span class="n">real</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_timeseries_mean</span><span class="o">.</span><span class="n">imag</span><span class="p">],</span><span class="s">&#39;m+&#39;</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;timeseries mean&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_normalized_timeseries</span><span class="o">.</span><span class="n">real</span><span class="p">[:</span><span class="mi">128</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_normalized_timeseries</span><span class="o">.</span><span class="n">imag</span><span class="p">[:</span><span class="mi">128</span><span class="p">],</span><span class="s">&#39;k,&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;timeseries samples&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_pass_normalized_timeseries</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">low_pass_normalized_timeseries</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="s">&#39;r,&#39;</span><span class="p">)</span> <span class="c">#uses proxy for label</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_meas_freq</span><span class="o">.</span><span class="n">real</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_model_s21_at_meas_freq</span><span class="o">.</span><span class="n">imag</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_ds21_df_at_meas_freq</span><span class="o">.</span><span class="n">real</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_ds21_df_at_meas_freq</span><span class="o">.</span><span class="n">imag</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span><span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s">&#39;-&gt;&#39;</span><span class="p">),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c">#proxies</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> kHz&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> kHz&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-.</span><span class="mi">55</span><span class="p">,</span><span class="o">.</span><span class="mi">55</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">handles</span><span class="p">,</span><span class="n">labels</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;dS21/(100Hz)&#39;</span><span class="p">)</span>
        <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;LPF timeseries&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;xx-small&#39;</span><span class="p">))</span>
        
        <span class="n">ax1b</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">parent_axes</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;20%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s">&quot;20%&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax1b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="p">,</span><span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_normalized_s21</span><span class="p">)),</span><span class="s">&#39;.-&#39;</span><span class="p">)</span>
        <span class="n">frm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_freqs_MHz</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">ax1b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frm</span><span class="p">,</span><span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_model_normalized_s21</span><span class="p">)))</span>
                
        <span class="n">freqs_fine</span><span class="p">,</span><span class="n">prr_fine</span><span class="p">,</span><span class="n">pii_fine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projected_fractional_fluctuation_spectra</span><span class="p">(</span><span class="n">NFFT</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">freqs_fine</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">prr_fine</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Srr&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">freqs_fine</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">pii_fine</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Sii&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs_coarse</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">prr_coarse</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs_coarse</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">pii_coarse</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_freq</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_eigvals</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">))</span>
        
        <span class="n">n500</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prr_coarse</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs_coarse</span><span class="o">-</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">ax2b</span><span class="o">.</span><span class="n">annotate</span><span class="p">((</span><span class="s">&quot;</span><span class="si">%.2g</span><span class="s"> Hz$^2$/Hz @ 500 Hz&quot;</span> <span class="o">%</span> <span class="n">n500</span><span class="p">),</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">n500</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span><span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">textcoords</span><span class="o">=</span><span class="s">&#39;offset points&#39;</span><span class="p">,</span>
                     <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s">&#39;-&gt;&#39;</span><span class="p">))</span>
        
        <span class="n">ax2b</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
    <span class="c">#    ax2b.set_xlim(ax2.get_xlim())</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax2b</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_freq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;1/Hz&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">))</span>
        
        <span class="n">tsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_pass_projected_timeseries</span>
        <span class="n">tsl</span> <span class="o">=</span> <span class="n">tsl</span> <span class="o">-</span> <span class="n">tsl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dtl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_pass_timestep</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dtl</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tsl</span><span class="p">))</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">tsl</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s">&#39;LPF timeseries real&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">tsl</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s">&#39;LPF timeseries imag&#39;</span><span class="p">)</span>
        <span class="n">load_fluctuations_mK</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_primary_load_temperature</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestream_primary_load_temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">*</span><span class="mf">1000.0</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestream_temperatures_sample_times</span><span class="p">,</span><span class="n">load_fluctuations_mK</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;seconds&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;xx-small&#39;</span><span class="p">))</span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_params</span>
        <span class="n">amp_noise_voltsrthz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mf">1.38e-23</span><span class="o">*</span><span class="mf">4.0</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">vread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_dbm</span><span class="o">/</span><span class="mf">10.0</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Qe</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q_e_real&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q_e_imag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">f0_dVdf</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">vread</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">Qe</span>
        <span class="n">expected_amp_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">amp_noise_voltsrthz</span><span class="o">/</span><span class="n">f0_dVdf</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
        <span class="n">text</span> <span class="o">=</span> <span class="p">((</span><span class="s">&quot;measured at: </span><span class="si">%.6f</span><span class="s"> MHz</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;temperature: </span><span class="si">%.1f</span><span class="s"> - </span><span class="si">%.1f</span><span class="s"> mK</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_temp</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_temp</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;power: ~</span><span class="si">%.1f</span><span class="s"> dBm (</span><span class="si">%.1f</span><span class="s"> dB att)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_dbm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">atten</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;fit f0: </span><span class="si">%.6f</span><span class="s"> +/- </span><span class="si">%.6f</span><span class="s"> MHz</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;f_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;f_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;Q: </span><span class="si">%.1f</span><span class="s"> +/- </span><span class="si">%.1f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;Re(Qe): </span><span class="si">%.1f</span><span class="s"> +/- </span><span class="si">%.1f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q_e_real&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;Q_e_real&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;|Qe|: </span><span class="si">%.1f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Qe</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;Qi: </span><span class="si">%.1f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_i</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s">&quot;Eamp: </span><span class="si">%.2g</span><span class="s"> 1/Hz&quot;</span> <span class="o">%</span> <span class="n">expected_amp_noise</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">expected_amp_noise</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">expected_amp_noise</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">expected_amp_noise</span><span class="p">,</span><span class="s">r&quot;expected amp noise&quot;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">))</span>
<span class="c">#        ax2.axhline(expected_amp_noise*4,linewidth=2,color=&#39;m&#39;)</span>
<span class="c">#        ax2.text(10,expected_amp_noise*4,r&quot;$\alpha = 0.5$&quot;,va=&#39;top&#39;,ha=&#39;left&#39;,fontdict=dict(size=&#39;small&#39;))</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">a: </span><span class="si">%.3g</span><span class="s"> +/- </span><span class="si">%.3g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>

        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax2b</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_measurement_freq_MHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2b</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;$Hz^2/Hz$&#39;</span><span class="p">)</span>

        
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="n">text</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">),</span><span class="n">transform</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">fontdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">))</span>
        
        <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">measured </span><span class="si">%s</span><span class="se">\n</span><span class="s">plotted </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_epoch</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f1</span>
        </div></div>
<div class="viewcode-block" id="load_noise_pkl"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.load_noise_pkl">[docs]</a><span class="k">def</span> <span class="nf">load_noise_pkl</span><span class="p">(</span><span class="n">pklname</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">pkl</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pkl</span>
</div>
<div class="viewcode-block" id="save_noise_pkl"><a class="viewcode-back" href="../../../kid_readout.analysis.html#kid_readout.analysis.noise_measurement.save_noise_pkl">[docs]</a><span class="k">def</span> <span class="nf">save_noise_pkl</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">pklname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">(),</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="s">&#39;readout&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">KID Readout  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>kid_readout.measurement.core &mdash; KID Readout  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="KID Readout  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">KID Readout  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kid_readout.measurement.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is the core of the measurement subpackage.</span>

<span class="sd">The main ideas are (1) to provide data container classes that define a format and include basic analysis code for the</span>
<span class="sd">data, and (2) to separate these data container classes from the format in which the data are stored on disk. These</span>
<span class="sd">goals are implemented using a Measurement class and a few functions and auxiliary classes.</span>

<span class="sd">The format is designed to handle hierarchical measurements naturally. For example, a frequency sweep is a collection</span>
<span class="sd">of streams of time-ordered data, so the both the class structure in memory and the hierarchical structure on disk are</span>
<span class="sd">a standard tree. This structure allows measurements that follow the specified format to be saved to disk and</span>
<span class="sd">re-created later without any additional metadata.</span>

<span class="sd">To create a new measurement, simply write a subclass of Measurement. Public attributes of the class will</span>
<span class="sd">automatically be saved to disk by the write() function and re-instantiated by the read() function. If a class</span>
<span class="sd">contains attributes that are either measurements or sequences of measurements (that use the provided MeasurementList</span>
<span class="sd">and MeasurementTuple containers), these will also be saved and restored correctly. Each Measurement should be</span>
<span class="sd">self-contained, meaning that it should contain all data and metadata necessary to analyze and understand it.</span>

<span class="sd">A measurement will typically contain arrays that contain most of the data and a state dictionary that holds metadata.</span>
<span class="sd">Because of restrictions imposed by the libraries used to store data on disk, the dictionary cannot hold arbitrary</span>
<span class="sd">values. See the Measurement docstring for details.</span>

<span class="sd">Because the same measurement class can potentially describe many measurements that use different equipment and thus</span>
<span class="sd">have different state data, the best way to handle presence or absence of equipment or settings is simply through the</span>
<span class="sd">presence or absence of entries in the state dictionary. It&#39;s easy for external code to check</span>
<span class="sd">if &#39;some_equipment_info&#39; in state: analyze_it()</span>
<span class="sd">to determine whether to analyze the information. If an entry has to be present for some reason, using None is better</span>
<span class="sd">than NaN to signify &quot;not available,&quot; even if the state value is usually a number. An example of a good reason would</span>
<span class="sd">be if some equipment was used during the measurement, but its state was not available when the measurement was</span>
<span class="sd">written. Besides the advantage of avoiding comparison subtleties, None will cause numeric operations to blow up</span>
<span class="sd">immediately.</span>

<span class="sd">Except for the root node, every node in the tree contains a measurement or a sequence of measurements. (The root node</span>
<span class="sd">is reserved for metadata.) Every node can thus be reached by a unique node path. For example, if the root contained</span>
<span class="sd">only one Sweepstream measurement with the name &quot;sweepstream,&quot; the structure would be</span>

<span class="sd">sweepstream</span>
<span class="sd">  stream</span>
<span class="sd">  sweep</span>
<span class="sd">    streams</span>
<span class="sd">      0</span>
<span class="sd">      1</span>
<span class="sd">      etc.</span>

<span class="sd">so the node path to the main SweepStream would be just &quot;sweepstream&quot; while the node path to one of the streams in the</span>
<span class="sd">sweep could be &quot;sweepstream:sweep:stream:1&quot; and so on. The node paths can be used to address the data structure in a</span>
<span class="sd">format-independent way in order to save new data in specific locations or to load subsets of the measurement tree.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">CLASS_NAME</span> <span class="o">=</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># This is the string used by writer objects to save class names.</span>

<span class="c1"># These names cannot be used for attributes because they are used as part of the public DataFrame interface.</span>
<span class="n">IO_CLASS_NAME</span> <span class="o">=</span> <span class="s1">&#39;io_class&#39;</span>  <span class="c1"># This is the fully-qualified name of the io class used to read a measurement from disk.</span>
<span class="n">IO_MODULE</span> <span class="o">=</span> <span class="s1">&#39;io_module&#39;</span>  <span class="c1"># This is the full-qualified name of the module used to read and write legacy data.</span>
<span class="n">ROOT_PATH</span> <span class="o">=</span> <span class="s1">&#39;root_path&#39;</span>  <span class="c1"># This is the root file or directory from which a measurement was read from disk.</span>
<span class="n">NODE_PATH</span> <span class="o">=</span> <span class="s1">&#39;node_path&#39;</span>  <span class="c1"># This is the node path from the root node to the measurement node.</span>

<span class="c1"># TODO: decide which names really need to be reserved.</span>
<span class="n">RESERVED_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLASS_NAME</span><span class="p">,</span> <span class="n">IO_CLASS_NAME</span><span class="p">,</span> <span class="n">IO_MODULE</span><span class="p">,</span> <span class="n">ROOT_PATH</span><span class="p">,</span> <span class="n">NODE_PATH</span><span class="p">]</span>
<span class="n">NODE_PATH_SEPARATOR</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an abstract class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The idea behind the _parent attribute is to give measurement contained in another measurement a reference to</span>
<span class="sd">        their parent. This enables measurements to discover their own node path relative to the top-level measurement.</span>

<span class="sd">        :return: a new Node instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.class_name"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Node.class_name">[docs]</a>    <span class="k">def</span> <span class="nf">class_name</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The purpose of this method is to allow classes to recommend some other class that should be used to load their</span>
<span class="sd">        data. For example, the IOList class cannot be instantiated using the data that it writes to disk, so its</span>
<span class="sd">        class_name() returns &#39;MeasurementList&#39; which is a class that can load the data.</span>

<span class="sd">        :return: the class name as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span></div>

<div class="viewcode-block" id="Node.node_list"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Node.node_list">[docs]</a>    <span class="k">def</span> <span class="nf">node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the node names in the hierarchy, ordered from the top level to self. For example, if self is</span>
<span class="sd">        the Stream stored at index 3 in the list of Streams in the Sweep of a SweepStream, this method would return</span>
<span class="sd">        [&#39;sweep&#39;, &#39;streams&#39;, &#39;3&#39;]</span>

<span class="sd">        Because this method has to traverse the contents of each parent, it could be slow for large structures.</span>

<span class="sd">        :return: a list of node names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">node_list</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param obj: the object to locate.</span>
<span class="sd">        :return: a string that is the proper reference for obj in self, which may be an attribute name, a dictionary</span>
<span class="sd">          key, or a sequence index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_io</span><span class="p">()</span></div>


<div class="viewcode-block" id="Measurement"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Measurement">[docs]</a><span class="k">class</span> <span class="nc">Measurement</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an abstract class that represents a measurement.</span>

<span class="sd">    To create a new measurement, simply write a subclass of Measurement that obeys the restrictions described here.</span>

<span class="sd">    Hierarchy.</span>
<span class="sd">    Measurements that are public attributes of a measurement will be automatically saved and loaded.</span>
<span class="sd">    Tuples or lists of measurements must be contained in MeasurementTuple or MeasurementList objects, which must also be</span>
<span class="sd">    public attributes.</span>

<span class="sd">    Instantiation.</span>
<span class="sd">    When a measurement is read from disk, the read() function inspects the signature of its __init__() method and</span>
<span class="sd">    calls it with the saved values of the corresponding variables. This allows every measurement read from disk to</span>
<span class="sd">    re-initialize itself and validate its data. However, because only public attributes are saved, this creates the</span>
<span class="sd">    restriction that a measurement must save the values with which it is initialized and cannot discard them or store</span>
<span class="sd">    them internally under other names. For example, if a measurement&#39;s __init__() method contained an argument foo</span>
<span class="sd">    that is stored as self.bar, the value in bar will be saved to disk as bar but the read() function will not be</span>
<span class="sd">    able to tell that this value should be passed as the value of parameter foo. See the instantiate() function.</span>

<span class="sd">    Arrays.</span>
<span class="sd">    Each measurement has a dimensions class attribute that contains metadata for its array dimensions. This is</span>
<span class="sd">    necessary for the netCDF4 IO class to handle the array dimensions correctly, and it also allows the classes to</span>
<span class="sd">    check the dimensions of their arrays on instantiation through the _validate_dimensions() method. The format of the</span>
<span class="sd">    an entry in the dimensions dict is &#39;array_name&#39;: dimension_tuple, where dimension tuple is a tuple of strings</span>
<span class="sd">    that are the names of the dimensions. To pass validation, each dimension name must correspond to an attribute or</span>
<span class="sd">    property of the class that is a 1-D array with size equal to the corresponding element of array.shape. Thus, arrays</span>
<span class="sd">    that have a given dimension must all have the same length along that dimension. For example, if there is an entry</span>
<span class="sd">    &#39;s21_raw&#39;: (&#39;time&#39;, &#39;frequency)</span>
<span class="sd">    and another entry</span>
<span class="sd">    &#39;frequency&#39;: (&#39;frequency&#39;,)</span>
<span class="sd">    then</span>
<span class="sd">    s21_raw.shape[1] == frequency.size</span>
<span class="sd">    must be True. If the array corresponding to some dimension is not intended to be saved, it can be implemented as a</span>
<span class="sd">    property. For example, in the case above, the &#39;time&#39; dimension could be implemented as a property. The instance</span>
<span class="sd">    would still pass validation as long as</span>
<span class="sd">    s21_raw.shape[0] == time.size</span>
<span class="sd">    were True.</span>

<span class="sd">    Containers.</span>
<span class="sd">    Measurements store state information in a dictionary. (They actually use a subclass called StateDict, which has</span>
<span class="sd">    extra access features and validation.) Implementations of the IO class must be able to store the following objects:</span>
<span class="sd">    -basic types, such as numbers, booleans, strings, booleans, and None;</span>
<span class="sd">    -sequences, i.e. lists, tuples, and arrays, that contain exactly one of the above basic types except None; sequences</span>
<span class="sd">     cannot contain other sequences, and all sequences are returned as lists on read.</span>
<span class="sd">    -dictionaries whose keys are strings and whose values are dictionaries, sequences, or basic types; the contained</span>
<span class="sd">     dictionaries and sequences have the same requirements as above.</span>
<span class="sd">    Classes that do not obey these restrictions may fail to save or may have missing or corrupted data when read from</span>
<span class="sd">    disk. Most of these restrictions come from the limitations of netCDF4 and json. Some of them could be relaxed</span>
<span class="sd">    with more work, if necessary.</span>

<span class="sd">    Two values that are particularly problematic are None and NaN. None requires a special case because netCDF4</span>
<span class="sd">    cannot write it, so it is allowed as an attribute value or dictionary value but not in sequences. NaN is stored</span>
<span class="sd">    and retrieved correctly but is not recommended as an indicator of missing state because it causes comparisons to</span>
<span class="sd">    fail: float(&#39;NaN&#39;) == float(&#39;NaN&#39;) is always False. See Measurement.__eq__() for more.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new Measurement instance.</span>

<span class="sd">        :param state: a dictionary of state information.</span>
<span class="sd">        :param description: a string describing the measurement.</span>
<span class="sd">        :return: a new Measurement instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Measurement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">to_state_dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_class</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_node_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dimensions</span><span class="p">()</span>

<div class="viewcode-block" id="Measurement.as_class"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Measurement.as_class">[docs]</a>    <span class="k">def</span> <span class="nf">as_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span></div>

<div class="viewcode-block" id="Measurement.to_dataframe"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Measurement.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pandas DataFrame containing data from this Measurement.</span>

<span class="sd">        This method should return state information and analysis products, such as fit parameters, but not large objects</span>
<span class="sd">        like time-ordered data.</span>

<span class="sd">        :return: a DataFrame containing data from this Measurement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Measurement.add_origin"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Measurement.add_origin">[docs]</a>    <span class="k">def</span> <span class="nf">add_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add to the given dataframe enough information to load the data from which it was created. Using this</span>
<span class="sd">        information, the from_series() function in this module will return the original data.</span>

<span class="sd">        This method adds the IO class, the path to the root file or directory, and the node path corresponding to this</span>
<span class="sd">        measurement, which will all be None unless the Measurement was created from files on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;io_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_class</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_path</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;node_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_path</span></div>

    <span class="c1"># TODO: add timestream or sweep indices?</span>
<div class="viewcode-block" id="Measurement.add_legacy_origin"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.Measurement.add_legacy_origin">[docs]</a>    <span class="k">def</span> <span class="nf">add_legacy_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add to the given dataframe information about the origin of the data. It&#39;s going to be difficult to implement</span>
<span class="sd">        automatic loading of original data, but at least this will record the netCDF4 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;io_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;kid_readout.measurement.legacy&#39;</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_path</span></div>

    <span class="k">def</span> <span class="nf">_validate_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dimension_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">dimension_tuple</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape of {} does not match size of {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dimension_tuple</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively compare two measurements. At each level, the function tests that both instances have the same public</span>
<span class="sd">        attributes (meaning those that do not start with an underscore), that all these attributes are equal,</span>
<span class="sd">        and that the classes of the measurements are equal. Because the data we store mixes booleans and numbers,</span>
<span class="sd">        boolean values stored as attributes are compared using identity, not equality. Note that this is not done</span>
<span class="sd">        within containers.</span>

<span class="sd">        The function does not compare private attributes, and does not even check whether the instances have the same</span>
<span class="sd">        private attributes.</span>

<span class="sd">        :param other: a Measurement instance.</span>
<span class="sd">        :return: True if self compares equal with other, and False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keys_s</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
            <span class="n">keys_o</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">__dict__</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys_s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys_o</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_s</span><span class="p">:</span>
                <span class="n">value_s</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">value_o</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value_s</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Measurement</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">value_s</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">value_o</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value_s</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">MeasurementList</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_o</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">meas_s</span><span class="p">,</span> <span class="n">meas_o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">value_s</span><span class="p">,</span> <span class="n">value_o</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="n">meas_s</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">meas_o</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>  <span class="c1"># This allows declared arrays to contain NaN and be equal.</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value_s</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value_o</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">value_s</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value_s</span><span class="p">)]</span> <span class="o">==</span> <span class="n">value_o</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value_o</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># This will fail for NaN or sequences that contain any NaN values.</span>
                    <span class="k">assert</span> <span class="n">value_s</span> <span class="o">==</span> <span class="n">value_o</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_s</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_o</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="n">value_s</span> <span class="ow">is</span> <span class="n">value_o</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="MeasurementList"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.MeasurementList">[docs]</a><span class="k">class</span> <span class="nc">MeasurementList</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measurements containing lists of Measurements must use instances of this class so that loading and saving are</span>
<span class="sd">    handled correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

<div class="viewcode-block" id="MeasurementList.append"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.MeasurementList.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="MeasurementList.extend"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.MeasurementList.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span></div>

<div class="viewcode-block" id="MeasurementList.insert"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.MeasurementList.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{}({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span></div>


<div class="viewcode-block" id="IOList"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList">[docs]</a><span class="k">class</span> <span class="nc">IOList</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="IOList.class_name"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.class_name">[docs]</a>    <span class="k">def</span> <span class="nf">class_name</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__name__</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MeasurementList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="IOList.append"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">node_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="IOList.extend"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="IOList.insert"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.remove"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.pop"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.index"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.index">[docs]</a>    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.count"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.sort"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="IOList.reverse"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IOList.reverse">[docs]</a>    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instances of this class appear like empty lists, so iteration stops immediately.</span>

<span class="sd">        :return: an empty iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{}({}, {})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">())</span></div>


<div class="viewcode-block" id="MeasurementError"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.MeasurementError">[docs]</a><span class="k">class</span> <span class="nc">MeasurementError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised for module-specific errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="StateDict"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.StateDict">[docs]</a><span class="k">class</span> <span class="nc">StateDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class adds attribute access and some content restrictions to the dict class.</span>

<span class="sd">    Measurements that require dictionaries can use the function to_state_dict() to perform partial validation of a</span>
<span class="sd">    dictionary to ensure that the data can be re-created properly from disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span>
    <span class="n">__getattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span>
    <span class="n">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__delitem__</span>
    <span class="n">__copy__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">StateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">__getstate__</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>


<span class="c1"># TODO: incorporate restrictions into __init__().</span>
<span class="c1"># TODO: implement more error checking.</span>
<div class="viewcode-block" id="to_state_dict"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.to_state_dict">[docs]</a><span class="k">def</span> <span class="nf">to_state_dict</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">MeasurementError</span><span class="p">(</span><span class="s2">&quot;Dictionary keys must be strings.&quot;</span><span class="p">)</span>
    <span class="n">dicts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">to_state_dict</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
    <span class="n">others</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">StateDict</span><span class="p">(</span><span class="n">dicts</span> <span class="o">+</span> <span class="n">others</span><span class="p">)</span></div>


<div class="viewcode-block" id="IO"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO">[docs]</a><span class="k">class</span> <span class="nc">IO</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an abstract class that specifies the IO interface.</span>

<span class="sd">    Implementations should be able to store large numpy arrays efficiently.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new IO object that will read to or write from the given root directory or file. If the root does not</span>
<span class="sd">        exist, it should be created. Implementations should NEVER open an existing file in write mode, and in general</span>
<span class="sd">        should make it impossible to overwrite data. Appending to existing files may be useful.</span>

<span class="sd">        :param root_path: the path to the root directory or file.</span>
<span class="sd">        :return: a new IO object that can read from and write to the root object at the given path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="IO.close"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close open files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if all files on disk are closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="IO.default_name"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.default_name">[docs]</a>    <span class="k">def</span> <span class="nf">default_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a name for the given measurement class or instance that is guaranteed to be unique at the root level.</span>

<span class="sd">        :param measurement: a Measurement subclass or instance.</span>
<span class="sd">        :return: a string consisting of the class name and a number that is one plus the number of measurements</span>
<span class="sd">          already stored at root level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">measurement</span><span class="o">.</span><span class="n">class_name</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurement_names</span><span class="p">()))</span></div>

<div class="viewcode-block" id="IO.write"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">node_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the measurement to disk at the given node path. If the measurement is written to the root level, this</span>
<span class="sd">        method changes the _parent attribute to self. This is used to enable building measurements sequentially.</span>

<span class="sd">        :param measurement: the measurement instance to write to disk.</span>
<span class="sd">        :param node_path: the node_path to the node that will contain this object; all but the final node in node_path</span>
<span class="sd">          must already exist.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_name</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_node</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">node_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">(</span><span class="n">node_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># the measurement has been stored at the root level</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">_saved_as</span> <span class="o">=</span> <span class="n">node_path</span></div>

<div class="viewcode-block" id="IO.read"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a measurement from disk and return it.</span>

<span class="sd">        :param node_path:the path to the node to be loaded, in the form &#39;node0:node1:node2&#39;</span>
<span class="sd">        :param translate: a dictionary with entries &#39;original_class&#39;: &#39;new_class&#39;; class names must be fully-qualified.</span>
<span class="sd">        :return: the measurement corresponding to the given node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">translate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">translate</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_node</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">translate</span><span class="p">)</span></div>

    <span class="c1"># These functions are used by</span>

<div class="viewcode-block" id="IO.create_node"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.create_node">[docs]</a>    <span class="k">def</span> <span class="nf">create_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a node at the end of the given path; all but the final node in the path must already exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.write_other"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.write_other">[docs]</a>    <span class="k">def</span> <span class="nf">write_other</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write value to node_path with name key; value should not be a numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.write_array"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.write_array">[docs]</a>    <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write value, a numpy array, to node_path with name key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.read_array"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.read_array">[docs]</a>    <span class="k">def</span> <span class="nf">read_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read array key from node_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.read_other"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.read_other">[docs]</a>    <span class="k">def</span> <span class="nf">read_other</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read non-array object with name key from node_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.measurement_names"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.measurement_names">[docs]</a>    <span class="k">def</span> <span class="nf">measurement_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the names of all measurements contained in the measurement at node_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.array_names"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.array_names">[docs]</a>    <span class="k">def</span> <span class="nf">array_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the names of all arrays contained in the measurement at node_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IO.other_names"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.IO.other_names">[docs]</a>    <span class="k">def</span> <span class="nf">other_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the names of all other variables contained in the measurement at node_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_names</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">()</span>

    <span class="c1"># TODO: re-implement if necessary; this was causing confusion with the memory io class.</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def __getitem__(self, item):</span>
<span class="sd">        try:</span>
<span class="sd">            return self.read(self.measurement_names()[item])</span>
<span class="sd">        except IndexError:</span>
<span class="sd">            raise KeyError()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: add methods?</span>
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the data in node to a new node at the given node path.</span>

<span class="sd">        :param node: a Node instance, which will usually be a Measurement or container for Measurements.</span>
<span class="sd">        :param node_path: the path of the new node into which the instance will be written.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span>
        <span class="n">this_class_name</span> <span class="o">=</span> <span class="s1">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">class_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_other</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">CLASS_NAME</span><span class="p">,</span> <span class="n">this_class_name</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RESERVED_NAMES</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">dimensions</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Measurement</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_node</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MeasurementList</span><span class="p">):</span>
                <span class="n">sequence_node_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">sequence_node_path</span><span class="p">)</span>
                <span class="n">sequence_class_name</span> <span class="o">=</span> <span class="s1">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">class_name</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_other</span><span class="p">(</span><span class="n">sequence_node_path</span><span class="p">,</span> <span class="n">CLASS_NAME</span><span class="p">,</span> <span class="n">sequence_class_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">meas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_node</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">sequence_node_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_other</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Saving arrays in order allows the netCDF group to create the dimensions.</span>
        <span class="k">for</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">dimensions</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">array_name</span><span class="p">),</span> <span class="n">dimensions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_path</span><span class="p">,</span> <span class="n">translate</span><span class="p">):</span>
        <span class="n">original_class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_other</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">CLASS_NAME</span><span class="p">)</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">original_class_name</span><span class="p">,</span> <span class="n">original_class_name</span><span class="p">)</span>
        <span class="n">measurement_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_names</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_sequence</span><span class="p">(</span><span class="n">class_name</span><span class="p">):</span>
            <span class="c1"># Use the name of each measurement, which is an int, to restore the order in the sequence.</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_node</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">measurement_name</span><span class="p">),</span> <span class="n">translate</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">measurement_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">measurement_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">instantiate_sequence</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">measurement_name</span> <span class="ow">in</span> <span class="n">measurement_names</span><span class="p">:</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">measurement_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_node</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">measurement_name</span><span class="p">),</span> <span class="n">translate</span><span class="p">)</span>
            <span class="n">array_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_names</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">array_names</span><span class="p">:</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">array_name</span><span class="p">)</span>
            <span class="n">other_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">vn</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_names</span><span class="p">(</span><span class="n">node_path</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">other_names</span><span class="p">:</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">other_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_other</span><span class="p">(</span><span class="n">node_path</span><span class="p">,</span> <span class="n">other_name</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">instantiate</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
        <span class="n">current</span><span class="o">.</span><span class="n">_io_class</span> <span class="o">=</span> <span class="s1">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">current</span><span class="o">.</span><span class="n">_root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span>
        <span class="n">current</span><span class="o">.</span><span class="n">_node_path</span> <span class="o">=</span> <span class="n">node_path</span>
        <span class="k">return</span> <span class="n">current</span>

    <span class="k">def</span> <span class="nf">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_saved_as</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement_names</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">MeasurementError</span><span class="p">(</span><span class="s2">&quot;{} named {} has not been saved by this IO instance.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_saved_as</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MeasurementError</span><span class="p">(</span><span class="s2">&quot;{} does not appear to have been written to disk.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_saved_as</span>

    <span class="k">def</span> <span class="nf">_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="c1"># Class-related functions</span>

<div class="viewcode-block" id="get_class"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.get_class">[docs]</a><span class="k">def</span> <span class="nf">get_class</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">):</span>
    <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">full_class_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="instantiate"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.instantiate">[docs]</a><span class="k">def</span> <span class="nf">instantiate</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import and instantiate a class using the data in the given dictionary.</span>

<span class="sd">    :param full_class_name: the fully-qualified class name as a string, e.g. &#39;kid_readout.measurement.core.Measurement&#39;.</span>
<span class="sd">    :param variables: a dictionary whose keys are the names of the variables available for instantiation and whose</span>
<span class="sd">      values are the corresponding values; it must include entries for all non-keyword arguments to __init__().</span>
<span class="sd">    :return: an instance of full_class_name instantiated using the given variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">class_</span> <span class="o">=</span> <span class="n">get_class</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">class_</span><span class="o">.</span><span class="n">__init__</span><span class="p">)</span>
    <span class="n">arg_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">defaults</span><span class="p">)):</span>
        <span class="n">arg_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">)]):</span>  <span class="c1"># The first arg is &#39;self&#39;</span>
        <span class="n">arg_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">class_</span><span class="p">(</span><span class="o">*</span><span class="nb">reversed</span><span class="p">(</span><span class="n">arg_values</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">instance</span></div>


<div class="viewcode-block" id="instantiate_sequence"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.instantiate_sequence">[docs]</a><span class="k">def</span> <span class="nf">instantiate_sequence</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_class</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">)(</span><span class="n">contents</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_sequence"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.is_sequence">[docs]</a><span class="k">def</span> <span class="nf">is_sequence</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">get_class</span><span class="p">(</span><span class="n">full_class_name</span><span class="p">),</span> <span class="n">MeasurementList</span><span class="p">)</span></div>


<div class="viewcode-block" id="from_series"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.from_series">[docs]</a><span class="k">def</span> <span class="nf">from_series</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">get_class</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">io_class</span><span class="p">)(</span><span class="n">series</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">node_path</span><span class="p">)</span></div>


<span class="c1"># Node-related functions</span>

<div class="viewcode-block" id="join"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.join">[docs]</a><span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Join the given nodes using the node path separator, like os.path.join(). Extra separators will be stripped.</span>

<span class="sd">    :param nodes: the nodes to join.</span>
<span class="sd">    :return: a string representing the joined path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">NODE_PATH_SEPARATOR</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">NODE_PATH_SEPARATOR</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">])</span></div>


<div class="viewcode-block" id="split"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.split">[docs]</a><span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">node_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the given path into a (head, tail) tuple, where tail is the last node in the path and head is the rest, like</span>
<span class="sd">    os.path.split(). For example,</span>
<span class="sd">    split(&#39;one:two:three&#39;)</span>
<span class="sd">    returns</span>
<span class="sd">    (&#39;one:two&#39;, &#39;three&#39;)</span>
<span class="sd">    If the path contains a single node, then head is the empty string and tail is that node.</span>

<span class="sd">    :param node_path: the node path to split.</span>
<span class="sd">    :return: a (head, tail) tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exploded</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">exploded</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">exploded</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="explode"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.explode">[docs]</a><span class="k">def</span> <span class="nf">explode</span><span class="p">(</span><span class="n">node_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of the node names in the given node path with the node separator removed. For example,</span>
<span class="sd">    explode(&#39;one:two:three&#39;)</span>
<span class="sd">    returns</span>
<span class="sd">    [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;]</span>

<span class="sd">    :param node_path: the node path to explode.</span>
<span class="sd">    :return: a list of the nodes in the path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">node_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">NODE_PATH_SEPARATOR</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_node_path"><a class="viewcode-back" href="../../../kid_readout.measurement.html#kid_readout.measurement.core.validate_node_path">[docs]</a><span class="k">def</span> <span class="nf">validate_node_path</span><span class="p">(</span><span class="n">node_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise a MeasurementError if the given non-empty node path is not valid; a valid node path is a string consisting of</span>
<span class="sd">    valid Python variables separated by colons, like &quot;one:two:three&quot;. The empty string &#39;&#39; corresponds to the root path,</span>
<span class="sd">    which cannot contain a measurement, so it is not a valid node path.</span>

<span class="sd">    :param node_path: The node path to validate.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">explode</span><span class="p">(</span><span class="n">node_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MeasurementError</span><span class="p">(</span><span class="s2">&quot;Empty node in {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_path</span><span class="p">))</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="s1">r&#39;[^\_\:A-Za-z0-9]&#39;</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="n">node_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MeasurementError</span><span class="p">(</span><span class="s2">&quot;Invalid character in {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_path</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">KID Readout  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2013, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>